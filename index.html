<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Minecraft VR - Andar no Lugar</title>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
    #renderCanvas { width: 100%; height: 100%; display: block; }
    #status {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-size: 18px; text-align: center; width: 80%;
    }
    #enter-vr {
      position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
      padding: 15px 30px; background: #E91E63; color: white; border: none;
      border-radius: 10px; font-size: 18px; cursor: pointer; z-index: 100;
    }
    #walk-button {
      position: absolute; bottom: 30px; right: 30px;
      width: 80px; height: 80px; background: rgba(255,255,255,0.3);
      border-radius: 50%; border: 2px solid white;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; color: white; z-index: 100;
      user-select: none;
    }
    #inventory {
      position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 10px; background: rgba(0,0,0,0.7); padding: 10px 20px;
      border-radius: 10px; z-index: 100;
    }
    .item {
      width: 50px; height: 50px; border: 3px solid #333; color: white;
      font-weight: bold; display: flex; align-items: center; justify-content: center;
      cursor: pointer; border-radius: 8px;
    }
    .item.selected { border-color: #4CAF50; background: rgba(76,175,84,0.3); }
  </style>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@webxr-polyfill/[email¬†protected]/dist/webxr-polyfill.js"></script>
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <div id="status">Toque na tela para andar</div>
  <button id="enter-vr" style="display:none">üï∂Ô∏è Entrar em VR</button>
  <div id="walk-button">Andar</div>
  <div id="inventory" style="display:none">
    <div class="item selected" data-type="grass">G</div>
    <div class="item" data-type="dirt">D</div>
    <div class="item" data-type="stone">S</div>
  </div>

  <script type="text/javascript">
    let engine, scene, camera;
    let blocks = {};
    let materials = {};
    let currentBlockType = "grass";
    let isWalking = false; // controle de movimento
    const walkSpeed = 0.15;

    window.addEventListener("load", () => {
      setTimeout(startApp, 200);
    });

    function startApp() {
      const canvas = document.getElementById("renderCanvas");

      engine = new BABYLON.Engine(canvas, true, {
        preserveDrawingBuffer: true,
        stencil: true
      }, true);

      if (!engine) {
        document.getElementById("status").innerText = "Erro: WebGL n√£o suportado";
        return;
      }

      scene = createScene();
      createMaterials();
      generateWorld();

      document.getElementById("status").style.display = "none";
      document.getElementById("enter-vr").style.display = "block";
      document.getElementById("inventory").style.display = "flex";

      document.getElementById("enter-vr").addEventListener("click", enterVR);

      // Invent√°rio
      document.querySelectorAll("#inventory .item").forEach(item => {
        item.onclick = () => {
          document.querySelectorAll("#inventory .item").forEach(i => i.classList.remove("selected"));
          item.classList.add("selected");
          currentBlockType = item.getAttribute("data-type");
        };
      });

      // === BOT√ÉO DE ANDAR NO LUGAR ===
      const walkButton = document.getElementById("walk-button");

      // Toque para andar
      walkButton.addEventListener("touchstart", (e) => {
        e.preventDefault();
        isWalking = true;
      });

      walkButton.addEventListener("touchend", (e) => {
        e.preventDefault();
        isWalking = false;
      });

      // Para desktop (teste com mouse)
      walkButton.addEventListener("mousedown", () => isWalking = true);
      walkButton.addEventListener("mouseup", () => isWalking = false);
      walkButton.addEventListener("mouseleave", () => isWalking = false);

      // Loop de movimento
      scene.onBeforeRenderObservable.add(() => {
        if (isWalking && camera) {
          const forward = new BABYLON.Vector3(
            Math.sin(camera.rotation.y),
            0,
            Math.cos(camera.rotation.y)
          );
          camera.position.addInPlace(forward.scale(walkSpeed));
        }
      });

      engine.runRenderLoop(() => scene.render());
      window.addEventListener("resize", () => engine.resize());
    }

    function createScene() {
      const scene = new BABYLON.Scene();
      scene.clearColor = new BABYLON.Color3(0.8, 0.9, 1.0);

      // C√¢mera com rota√ß√£o (para andar na dire√ß√£o da vis√£o)
      camera = new BABYLON.DeviceOrientationCamera("camera", new BABYLON.Vector3(0, 1.6, -5), scene);
      camera.attachControl(true, true);
      camera.speed = 0.1;

      const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
      light.intensity = 0.8;

      return scene;
    }

    function createMaterials() {
      materials.grass = new BABYLON.StandardMaterial("grass", scene);
      materials.grass.diffuseColor = new BABYLON.Color3(0.2, 0.8, 0.2);

      materials.dirt = new BABYLON.StandardMaterial("dirt", scene);
      materials.dirt.diffuseColor = new BABYLON.Color3(0.4, 0.2, 0.1);

      materials.stone = new BABYLON.StandardMaterial("stone", scene);
      materials.stone.diffuseColor = new BABYLON.Color3(0.5, 0.5, 0.5);
    }

    function generateWorld() {
      for (let x = -15; x <= 15; x += 2) {
        for (let z = -15; z <= 15; z += 2) {
          const y = Math.floor(Math.sin(x / 5) * 2 + Math.cos(z / 5) * 2);
          createBlock(x, y, z, "grass");
          if (y > 0) createBlock(x, y - 1, z, "dirt");
          if (y > -2) createBlock(x, y - 2, z, "stone");
        }
      }
    }

    function createBlock(x, y, z, type) {
      const key = `${x},${y},${z}`;
      if (blocks[key]) return;
      const box = BABYLON.MeshBuilder.CreateBox("block", { size: 1 }, scene);
      box.position.set(x, y + 0.5, z);
      box.material = materials[type];
      box.checkCollisions = true;
      box.isPickable = true;
      blocks[key] = box;
    }

    // === INTERA√á√ÉO: Quebrar bloco com toque ===
    document.getElementById("renderCanvas").addEventListener("click", () => {
      const ray = camera.getForwardRay(10);
      const hit = scene.pickWithRay(ray);
      if (hit?.pickedMesh) {
        const pos = hit.pickedMesh.position;
        const key = `${Math.round(pos.x)},${Math.round(pos.y - 0.5)},${Math.round(pos.z)}`;
        if (blocks[key]) {
          blocks[key].dispose();
          delete blocks[key];
        }
      }
    });

    // === VR ===
    async function enterVR() {
      try {
        const vrHelper = await scene.createDefaultVRExperience({
          createDeviceOrientationCamera: false
        });
        await vrHelper.webVROptions.enterVR();
        document.getElementById("enter-vr").style.display = "none";
      } catch (e) {
        alert("VR n√£o suportado: " + e.message);
      }
    }
  </script>
</body>
</html>
